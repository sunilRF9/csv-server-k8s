apiVersion: v1
kind: Pod
metadata:
  labels:
    run: csvserver
  name: csvserver
spec:
  initContainers:
  - name: init
    image: bash:4.4
    command: ["bash"]
    args: ["./csvserver/gencsv.sh"]
    volumeMounts:
      - name: gencsv
        mountPath: "/csvserver/gencsv.sh"
        subPath: "gencsv.sh"
      - name: inputdata
        mountPath: "/csvserver"
  containers:
  - image: infracloudio/csvserver:latest
    name: csvserver
    ports:
    - containerPort: 9300
    env:
      - name: CSVSERVER_BORDER
        valueFrom:
          secretKeyRef:
            name: csv-secret
            key: CSVSERVER_BORDER
    volumeMounts:
      - name: inputdata
        mountPath: "/csvserver/inputdata"
        subPath: "inputdata"
  volumes:
    - name: inputdata
      emptyDir: {}
    - name: gencsv
      configMap:
        name: gencsv
        defaultMode: 0755
